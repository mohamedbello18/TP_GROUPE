<?php
header('Content-Type: application/json');

// Connexion base de données
$host = 'sql204.infinityfree.com';
$dbname = 'tp_groupe';
$username = 'if0_40542812';
$password = 'iDqKrepEsjy2';

try {
    $pdo = new PDO("mysql:host=$host;dbname=$dbname;charset=utf8", $username, $password);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch(PDOException $e) {
    // Si la base n'existe pas, on la crée
    $pdo = new PDO("mysql:host=$host;charset=utf8", $username, $password);
    $pdo->exec("CREATE DATABASE IF NOT EXISTS `$dbname`");
    $pdo = new PDO("mysql:host=$host;dbname=$dbname;charset=utf8", $username, $password);
}

// Créer la table si elle n'existe pas
$sqlCreateTable = "
CREATE TABLE IF NOT EXISTS contacts (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) NOT NULL,
    subject VARCHAR(200) NOT NULL,
    message TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)";
$pdo->exec($sqlCreateTable);

// Récupérer les données du formulaire
$name = trim($_POST['name'] ?? '');
$email = trim($_POST['email'] ?? '');
$subject = trim($_POST['subject'] ?? '');
$message = trim($_POST['message'] ?? '');

$errors = [];

// Validation
if(empty($name)) {
    $errors['name'] = 'Le nom est obligatoire';
} elseif(strlen($name) < 2) {
    $errors['name'] = 'Le nom doit contenir au moins 2 caractères';
}

if(empty($email)) {
    $errors['email'] = 'L\'email est obligatoire';
} elseif(!filter_var($email, FILTER_VALIDATE_EMAIL)) {
    $errors['email'] = 'Email invalide';
}

if(empty($subject)) {
    $errors['subject'] = 'Le sujet est obligatoire';
}

if(empty($message)) {
    $errors['message'] = 'Le message est obligatoire';
}

// Si il y a des erreurs, on les retourne
if(!empty($errors)) {
    echo json_encode(['success' => false, 'message' => 'Veuillez corriger les erreurs du formulaire', 'errors' => $errors]);
    exit;
}

// Insérer dans la base
try {
    $sql = "INSERT INTO contacts (name, email, subject, message) VALUES (?, ?, ?, ?)";
    $stmt = $pdo->prepare($sql);
    $stmt->execute([$name, $email, $subject, $message]);
    
    echo json_encode(['success' => true, 'message' => 'Message enregistré avec succès']);
} catch(PDOException $e) {
    echo json_encode(['success' => false, 'message' => 'Erreur lors de l\'enregistrement: ' . $e->getMessage()]);
}
?>
